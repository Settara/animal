<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <style>
        .card-custom {
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            padding: 2rem;
        }
        .form-label {
            font-weight: 500;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }
        #imagePreview {
            max-width: 200px;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
        }
    </style>
</head>
<body class="bg-light">

<header class="bg-white shadow-sm p-3 mb-4">
    <div class="container d-flex flex-wrap justify-content-between align-items-center">
        <h3 class="mb-0">üì¢ –°–æ–∑–¥–∞–Ω–∏–µ</h3>
        <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
            <a href="/giveaway" class="btn btn-outline-primary">–ò—â–µ–º –Ω–æ–≤—ã—Ö —Ö–æ–∑—è–µ–≤</a>
            <a href="/tape" class="btn btn-outline-primary">–õ–µ–Ω—Ç–∞</a>
            <a href="/adverts/create" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</a>
            <a href="/adverts/my-adverts" class="btn btn-outline-primary">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a th:href="@{/profile/{id}(id=${user.id})}" class="btn btn-outline-primary">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="/posts/create" class="btn btn-outline-primary">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</a>
            <a href="/" class="btn btn-outline-dark">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
    </div>
</header>

<div class="container mb-5">
    <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
        <p th:text="${errorMessage}"></p>
    </div>

    <div class="card card-custom mx-auto" style="max-width: 800px;">
        <h4 class="section-title">üì¢ –ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h4>

        <form th:action="@{/adverts/add}" method="post" enctype="multipart/form-data" onsubmit="return validateForm(event)">
            <div class="mb-3">
                <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-control" id="description" name="description" rows="4" maxlength="500" required></textarea>
                <div class="form-text">–ú–∞–∫—Å–∏–º—É–º 500 —Å–∏–º–≤–æ–ª–æ–≤</div>
            </div>

            <div class="mb-3">
                <label for="address" class="form-label">–ê–¥—Ä–µ—Å</label>
                <input type="text" class="form-control" id="address" name="address" maxlength="200" required>
                <div class="form-text">–ú–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤</div>
            </div>

            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="noImage" name="noImage" onclick="toggleImageInput()">
                <label class="form-check-label" for="noImage">–ë–µ–∑ —Ñ–æ—Ç–æ</label>
            </div>

            <div class="mb-3">
                <label for="imageFile" class="form-label">–§–æ—Ç–æ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ</label>
                <input type="file" class="form-control" id="imageFile" name="imageFile" accept="image/*" required>
                <img id="imagePreview" class="img-thumbnail" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
            </div>

            <div class="mb-3">
                <label for="city" class="form-label">–ì–æ—Ä–æ–¥</label>
                <select class="form-select" id="city" name="cityId" required>
                    <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                    <option th:each="city : ${cities}" th:value="${city.id}" th:text="${city.title}"></option>


                </select>
            </div>


            <div class="mb-3">
                <label for="typeOfAnimalId" class="form-label">–¢–∏–ø –∂–∏–≤–æ—Ç–Ω–æ–≥–æ</label>
                <select class="form-select" id="typeOfAnimalId" name="typeOfAnimalId" required>
                    <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                    <option th:each="type : ${animalTypes}" th:value="${type.id}" th:text="${type.title}"></option>
                </select>
            </div>

            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="giveAway" name="giveAway">
                <label class="form-check-label" for="giveAway">–Ø —Ö–æ—á—É –æ—Ç–¥–∞—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ</label>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-success btn-lg">üì® –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleImageInput() {
        const checkbox = document.getElementById('noImage');
        const imageInput = document.getElementById('imageFile');
        const preview = document.getElementById('imagePreview');
        imageInput.disabled = checkbox.checked;
        imageInput.required = !checkbox.checked;
        imageInput.closest('.mb-3').style.display = checkbox.checked ? 'none' : 'block';
        if (checkbox.checked) {
            preview.style.display = 'none';
            preview.src = '#';
        }
    }

    function validateForm(event) {
        const description = document.getElementById("description");
        const address = document.getElementById("address");
        let errorMessages = [];
        let hasErrors = false;

        if (description.value.trim().length > 495) {
            errorMessages.push("–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 500 —Å–∏–º–≤–æ–ª–æ–≤.");
            description.value = "";
            hasErrors = true;
        }

        if (address.value.trim().length > 200) {
            errorMessages.push("–ê–¥—Ä–µ—Å –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 200 —Å–∏–º–≤–æ–ª–æ–≤.");
            address.value = "";
            hasErrors = true;
        }

        if (hasErrors) {
            event.preventDefault();
            alert(errorMessages.join("\n"));
            return false;
        }
        return true;
    }

    document.getElementById("imageFile").addEventListener("change", function () {
        const file = this.files[0];
        const preview = document.getElementById("imagePreview");
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = "none";
        }
    });

    regionSelect.addEventListener('change', function () {
        const regionId = this.value;
        if (!regionId) {
            citySelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω --</option>';
            return;
        }

        fetch(`/api/regions/${regionId}/cities`)
            .then(response => response.json())
            .then(cities => {
                citySelect.innerHTML = '';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.title;
                    citySelect.appendChild(option);
                });
            });
    });
</script>

</body>
</html>
